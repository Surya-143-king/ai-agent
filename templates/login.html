<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Management System - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }
        .logo {
            font-size: 3rem;
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: bold;
        }
        .btn-custom:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        .user-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .user-type-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .user-type-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .user-type-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .user-type-btn i {
            font-size: 2rem;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <i class="bi bi-hospital"></i>
        </div>
        <h2 class="text-center mb-1">Healthcare Management</h2>
        <p class="text-center text-muted mb-4">Login to your account or register as a new patient</p>
        
        <!-- Nav tabs -->
        <ul class="nav nav-tabs justify-content-center mb-4" id="authTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="true">Login</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="false">Register</button>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            <!-- Login Tab -->
            <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                <div class="user-type-selector">
                    <div class="user-type-btn active" data-type="employee">
                        <i class="bi bi-person-badge d-block text-center"></i>
                        <div class="text-center mt-2"><strong>Employee</strong></div>
                    </div>
                    <div class="user-type-btn" data-type="patient">
                        <i class="bi bi-person-heart d-block text-center"></i>
                        <div class="text-center mt-2"><strong>Patient</strong></div>
                    </div>
                </div>

                <form id="loginForm">
                    <input type="hidden" id="userType" value="employee">
                    
                    <div class="mb-3">
                <label class="form-label">Username or Email</label>
                <input type="text" class="form-control" id="username" required>
                <small class="form-text text-muted" id="usernameHint">Enter your username or registered email address</small>
            </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="errorMsg"></div>
                    
                    <button type="submit" class="btn btn-custom btn-primary w-100">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        Login
                    </button>
                </form>
            </div>

            <!-- Register Tab -->
            <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                <div class="user-type-selector mb-3">
                    <div class="user-type-btn active" data-type="patient">
                        <i class="bi bi-person-heart d-block text-center"></i>
                        <div class="text-center mt-2"><strong>Patient</strong></div>
                    </div>
                    <div class="user-type-btn" data-type="employee">
                        <i class="bi bi-person-badge d-block text-center"></i>
                        <div class="text-center mt-2"><strong>Employee</strong></div>
                    </div>
                </div>

                <form id="registerForm">
                    <input type="hidden" id="regUserType" value="patient">
                    
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="regName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="regPhone" required>
                    </div>
                    
                    <div id="patientFields">
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="regDob" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Gender</label>
                            <select class="form-control" id="regGender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="regAddress" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Blood Group</label>
                            <select class="form-control" id="regBloodGroup" required>
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="employeeFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-control" id="regRole" required>
                                <option value="">Select Role</option>
                                <option value="Doctor">Doctor</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Pharmacist">Pharmacist</option>
                                <option value="Lab Technician">Lab Technician</option>
                                <option value="Receptionist">Receptionist</option>
                                <option value="Administrator">Administrator</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-control" id="regDepartment" required>
                                <option value="">Select Department</option>
                                <option value="Cardiology">Cardiology</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Orthopedics">Orthopedics</option>
                                <option value="Neurology">Neurology</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Surgery">Surgery</option>
                                <option value="General Medicine">General Medicine</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="regPassword" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="regConfirmPassword" required>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="regErrorMsg"></div>
                    <div class="alert alert-success d-none" id="regSuccessMsg"></div>
                    
                    <button type="submit" class="btn btn-custom btn-primary w-100">
                        <i class="bi bi-person-plus me-2"></i>
                        Register
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap tabs
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab functionality
            const triggerTabList = [].slice.call(document.querySelectorAll('#authTabs button'))
            triggerTabList.forEach(function (triggerEl) {
                const tabTrigger = new bootstrap.Tab(triggerEl)
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault()
                    tabTrigger.show()
                })
            })
        });

        // User type selection (only for login tab)
        document.querySelectorAll('.user-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('userType').value = this.dataset.type;
                
                // Update username hint
                const hint = document.getElementById('usernameHint');
                hint.textContent = 'Enter your username or registered email address';
            });
        });

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.classList.add('d-none');
            
            const data = {
                user_type: document.getElementById('userType').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();

                   if (result.success) {
                     window.location.replace(result.redirect);
                    } else {
                     errorMsg.textContent = result.message;
                     errorMsg.classList.remove('d-none');
                       }

            } catch (error) {
                errorMsg.textContent = 'Login failed. Please try again.';
                errorMsg.classList.remove('d-none');
            }
        });

        // Registration user type selection
        document.querySelectorAll('#register .user-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#register .user-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('regUserType').value = this.dataset.type;
                
                // Show/hide fields based on user type
                const patientFields = document.getElementById('patientFields');
                const employeeFields = document.getElementById('employeeFields');
                const patientInputs = patientFields.querySelectorAll('input, select, textarea');
                const employeeInputs = employeeFields.querySelectorAll('input, select, textarea');
                
                if (this.dataset.type === 'patient') {
                    patientFields.style.display = 'block';
                    employeeFields.style.display = 'none';
                    patientInputs.forEach(input => input.required = true);
                    employeeInputs.forEach(input => input.required = false);
                } else {
                    patientFields.style.display = 'none';
                    employeeFields.style.display = 'block';
                    patientInputs.forEach(input => input.required = false);
                    employeeInputs.forEach(input => input.required = true);
                }
            });
        });

        // Registration form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const regErrorMsg = document.getElementById('regErrorMsg');
            const regSuccessMsg = document.getElementById('regSuccessMsg');
            regErrorMsg.classList.add('d-none');
            regSuccessMsg.classList.add('d-none');
            
            const userType = document.getElementById('regUserType').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                regErrorMsg.textContent = 'Passwords do not match.';
                regErrorMsg.classList.remove('d-none');
                return;
            }
            
            const data = {
                user_type: userType,
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                phone: document.getElementById('regPhone').value,
                password: password
            };
            
            if (userType === 'patient') {
                data.dob = document.getElementById('regDob').value;
                data.gender = document.getElementById('regGender').value;
                data.address = document.getElementById('regAddress').value;
                data.blood_group = document.getElementById('regBloodGroup').value;
            } else {
                data.role = document.getElementById('regRole').value;
                data.department = document.getElementById('regDepartment').value;
            }
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    regSuccessMsg.textContent = result.message + ' You can login using your email address.';
                    regSuccessMsg.classList.remove('d-none');
                    document.getElementById('registerForm').reset();
                    // Reset to patient type
                    document.querySelector('#register .user-type-btn[data-type="patient"]').click();
                    // Switch to login tab
                    const loginTab = new bootstrap.Tab(document.getElementById('login-tab'));
                    loginTab.show();
                } else {
                    regErrorMsg.textContent = result.message;
                    regErrorMsg.classList.remove('d-none');
                }
            } catch (error) {
                regErrorMsg.textContent = 'Registration failed. Please try again.';
                regErrorMsg.classList.remove('d-none');
            }
        });
    </script>
    <script>
/* ---------- Keep existing login behavior above. This script augments the page with OTP features ---------- */

/*
  How this works (non-intrusive):
  - Adds two small buttons next to the Login button: "Request OTP" and "Verify OTP".
  - Request OTP will send { identifier: <username> } to /api/request-otp (dev: OTP printed to server console).
  - Verify OTP prompts for the 6-digit code and calls /api/verify-otp.
  - On successful verify, server sets session and returns ok -> redirect to employee dashboard.
  - Normal username/password login still works unchanged.
*/

(function() {
  // find the Login button and insert small OTP controls next to it
  const loginBtn = document.querySelector('#loginForm button[type="submit"]');
  if (!loginBtn) return; // nothing to do

  // create container for OTP buttons
  const otpContainer = document.createElement('div');
  otpContainer.style.display = 'flex';
  otpContainer.style.gap = '8px';
  otpContainer.style.marginTop = '10px';

  // small style reused from bootstrap classes
  const btnBaseClass = 'btn btn-sm';

  // Optional UX: show a tiny tooltip hint near username when employee selected
  function updateUsernameHint() {
    // Implementation can be added if needed
  }

  // attach listeners to update on user type change
  document.querySelectorAll('#login .user-type-btn').forEach(b => b.addEventListener('click', updateUsernameHint));
  // initial call
  updateUsernameHint();

})();
</script>
</body>
</html>
